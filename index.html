<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Workflow Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --background-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--primary-color);
            line-height: 1.6;
        }

        .navbar {
            background-color: var(--primary-color);
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            color: white !important;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border: none;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem;
            font-weight: bold;
        }

        .form-control {
            border-radius: 5px;
            border: 2px solid #ddd;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .message {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .message.error {
            border-left-color: var(--error-color);
            background-color: rgba(231, 76, 60, 0.1);
        }

        .message.success {
            border-left-color: var(--success-color);
            background-color: rgba(46, 204, 113, 0.1);
        }

        .workflow-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
            font-weight: bold;
        }

        .status-running {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .agent-card {
            border-left: 4px solid var(--secondary-color);
            margin-bottom: 1rem;
        }

        .visualization-container {
            height: 400px;
            background-color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        #network-graph {
            width: 100%;
            height: 100%;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .tooltip-inner {
            max-width: 300px;
        }

        .log-entry {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .timestamp {
            color: #666;
            margin-right: 0.5rem;
        }

        #error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        #messages {
            overflow: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>Multi-Agent Workflow System
            </a>
            <div class="d-flex">
                <span class="text-light" id="connection-status">
                    <i class="fas fa-circle text-success me-2"></i>Connected
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <div class="row">
            <!-- Workflow Control Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs me-2"></i>Workflow Control
                    </div>
                    <div class="card-body">
                        <form id="workflow-form">
                            <div class="mb-3">
                                <label for="input-data" class="form-label">Input Data</label>
                                <textarea class="form-control" id="input-data" rows="4" placeholder="Enter JSON input data" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="agent-selection" class="form-label">Select Agents</label>
                                <select class="form-select" id="agent-selection" multiple>
                                    <option value="agent_a">Agent A</option>
                                    <option value="agent_b">Agent B</option>
                                    <option value="agent_c">Agent C</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-play me-2"></i>Start Workflow
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Workflow Status -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-2"></i>Current Status
                    </div>
                    <div class="card-body">
                        <p><strong>State ID:</strong> <span id="state-id">-</span></p>
                        <p><strong>Status:</strong> <span id="workflow-status" class="workflow-status">Not Started</span></p>
                        <p><strong>Active Agents:</strong> <span id="active-agents">0</span></p>
                        <p><strong>Messages Processed:</strong> <span id="messages-count">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-project-diagram me-2"></i>Workflow Visualization
                    </div>
                    <div class="card-body">
                        <div class="visualization-container">
                            <div id="network-graph"></div>
                        </div>
                    </div>
                </div>

                <!-- Message Log -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-comments me-2"></i>Message Log
                        </div>
                        <button class="btn btn-sm btn-outline-light" id="clear-log" title="Clear message log">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="messages"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Store Panel -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-database me-2"></i>Data Store
                    </div>
                    <div class="card-body">
                        <pre id="data-store" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Processing workflow...</p>
    </div>

    <!-- Error Toast -->
    <div class="toast" id="error-toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="error-message"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    
    <script>
        // Global variables
        let currentStateId = null;
        let networkInstance = null;
        let updateInterval = null;
        const toast = new bootstrap.Toast(document.getElementById('error-toast'));

        // Initialize network visualization
        function initializeNetwork() {
            const container = document.getElementById('network-graph');
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 30,
                    font: {
                        size: 14,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: { inherit: 'from' },
                    smooth: {
                        type: 'continuous'
                    },
                    arrows: {
                        to: { enabled: true, scaleFactor: 1 }
                    }
                },
                physics: {
                    stabilization: false,
                    barnesHut: {
                        gravitationalConstant: -80000,
                        springConstant: 0.001,
                        springLength: 200
                    }
                }
            };

            const data = {
                nodes: new vis.DataSet([]),
                edges: new vis.DataSet([])
            };

            networkInstance = new vis.Network(container, data, options);
        }

        // Update network visualization
        function updateVisualization(agents, messages) {
            if (!networkInstance) return;

            const nodes = new vis.DataSet();
            const edges = new vis.DataSet();

            // Add agent nodes
            agents.forEach(agent => {
                nodes.add({
                    id: agent.id,
                    label: agent.name,
                    color: {
                        background: '#3498db',
                        border: '#2980b9'
                    },
                    title: `Status: ${agent.status}<br>Tasks: ${agent.tasks_completed}`
                });
            });

            // Add message edges
            messages.forEach((msg, index) => {
                edges.add({
                    id: index,
                    from: msg.from,
                    to: msg.to,
                    label: msg.type,
                    arrows: 'to'
                });
            });

            networkInstance.setData({ nodes, edges });
        }

        // Add message to log
        function addMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('log-entry');
            
            const timestamp = new Date().toLocaleTimeString();
            messageElement.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="message ${type}">${message}</span>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Update workflow status
        function updateStatus(status) {
            const statusElement = document.getElementById('workflow-status');
            statusElement.className = 'workflow-status';
            
            switch(status.toLowerCase()) {
                case 'running':
                    statusElement.classList.add('status-running');
                    statusElement.textContent = 'Running';
                    break;
                case 'completed':
                    statusElement.classList.add('status-completed');
                    statusElement.textContent = 'Completed';
                    break;
                case 'error':
                    statusElement.classList.add('status-error');
                    statusElement.textContent = 'Error';
                    break;
                default:
                    statusElement.textContent = status;
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            toast.show();
        }

        // Fetch workflow state
        async function fetchWorkflowState() {
            if (!currentStateId) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/workflow/${currentStateId}/`);
                if (!response.ok) throw new Error('Failed to fetch workflow state');

                const data = await response.json();
                
                // Update UI elements
                document.getElementById('state-id').textContent = currentStateId;
                document.getElementById('active-agents').textContent = data.active_agents.length;
                document.getElementById('messages-count').textContent = data.messages.length;
                document.getElementById('data-store').textContent = JSON.stringify(data.data_store, null, 2);
                
                // Update visualization
                updateVisualization(data.active_agents, data.messages);
                
                // Update status
                updateStatus(data.status);
                
                // Add new messages
                data.messages.forEach(msg => addMessage(msg));
                
                // Stop polling if workflow is completed
                if (data.status.toLowerCase() === 'completed') {
                    clearInterval(updateInterval);
                    document.getElementById('loading-spinner').style.display = 'none';
                }
            } catch (error) {
                showError(`Error fetching workflow state: ${error.message}`);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            initializeNetwork();

            // Handle form submission
            document.getElementById('workflow-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const inputData = document.getElementById('input-data').value;
                const selectedAgents = Array.from(document.getElementById('agent-selection').selectedOptions)
                    .map(option => option.value);

                document.getElementById('loading-spinner').style.display = 'block';

                try {
                    // Start workflow
                    const response = await fetch('http://127.0.0.1:8000/workflow/start/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input_data: JSON.parse(inputData),
                            agents: selectedAgents
                        })
                    });

                    if (!response.ok) throw new Error('Failed to start workflow');

                    const data = await response.json();
                    currentStateId = data.state_id;
                    
                    // Start polling for updates
                    clearInterval(updateInterval);
                    updateInterval = setInterval(fetchWorkflowState, 1000);
                    
                    addMessage('Workflow started successfully', 'success');
                } catch (error) {
                    showError(`Error starting workflow: ${error.message}`);
                    document.getElementById('loading-spinner').style.display = 'none';
                }
            });

            // Handle clear log button
            document.getElementById('clear-log').addEventListener('click', () => {
                document.getElementById('messages').innerHTML = '';
            });

            // Check server connection
            fetch('http://127.0.0.1:8000/health/')
                .catch(() => {
                    document.getElementById('connection-status').innerHTML = `
                        <i class="fas fa-circle text-danger me-2"></i>Disconnected
                    `;
                });
        });
    </script>
</body>
</html>